var MQeditor=function(y){var h={layoutstyle:"auto",layout:[]},u={},f=null,l=null,p=null,g=MathQuill.getInterface(MathQuill.getInterface.MAX);function n(t,e,a){var n,o,s,l,i,r,d,c;"string"==typeof t&&(t=document.getElementById(t)),n="boolean"==typeof e?e:"hidden"!=t.type,o=t.id,!0===n?(s=y(t).attr("type","hidden").val(),h.hasOwnProperty("toMQ")&&(s=h.toMQ(s)),0==(l=y("#mqinput-"+o)).length?(i=y("<span/>",{id:"mqinput-"+o,class:"mathquill-math-field",text:s}),null!==(r=t.className.match(/(ansred|ansyel|ansgrn)/))&&i.addClass(r[0]),d=t.hasAttribute("size")?3<t.size?t.size/1.8:t.size:10,i.css("min-width",d+"em"),i.insertAfter(t),c={handlers:{edit:q,enter:w}},h.hasOwnProperty("getLayoutstyle")?h.curlayoutstyle=h.getLayoutstyle():"auto"==h.layoutstyle?h.curlayoutstyle=v():h.curlayoutstyle=h.layoutstyle,"OSK"==h.curlayoutstyle&&(c.substituteTextarea=function(){var t=document.createElement("span");return t.setAttribute("tabindex",0),t},c.keyboardPassthrough=!0),l=g.MathField(i[0],c).config(u),b(i)):(l.show(),l=g(l[0]).latex(s)),!0!==a&&l.focus()):(y(t).attr("type","text"),!0!==a&&y(t).focus(),y("#mqinput-"+o).hide())}function b(t){y(t).find(".mq-textarea > *").on("focus.mqeditor",e).on("blur.mqeditor",function(){l=setTimeout(a,100)})}function e(t){var a,e,n,o,s;clearTimeout(l),a=y(t.target).closest(".mathquill-math-field"),null===f&&(y("body").append(y("<div/>",{id:"mqeditor",class:"mqeditor"})),y("#mqeditor").on("mousedown touchstart",function(t){t.preventDefault()})),e=h.curlayoutstyle,h.hasOwnProperty("getLayoutstyle")?h.curlayoutstyle=h.getLayoutstyle():"auto"==h.layoutstyle?h.curlayoutstyle=v():h.curlayoutstyle=h.layoutstyle,"OSK"===h.curlayoutstyle?(y("#mqeditor").addClass("fixedbottom"),document.getElementById("mqe-fb-spacer")||((n=document.createElement("div")).style.height="200px",n.id="mqe-fb-spacer",y("body").append(n))):y("#mqeditor").removeClass("fixedbottom"),o=!1,null!==f&&a[0]==f.el()&&e===h.curlayoutstyle||(o=!0,null!==f&&y("#"+f.el().id.substring(8)).trigger("change"),h.hasOwnProperty("getLayout")&&(h.layout=h.getLayout(a[0],h.curlayoutstyle)),y("#mqeditor").empty().show(),h.layout.tabs?function(t,e,a){var n,o,s,l,i,r,d=document.createElement("div");d.className="mqed-row mqed-tabrow";n=document.createElement("div"),l=0;t.appendChild(d),t.appendChild(n);for(i=0;i<e.tabs.length;i++)if(!0===e.tabs[i].enabled)for(l++,E(d,e.tabs[i],a+"-"+i),(s=document.createElement("div")).className="mqed-row mqed-tabpanel",s.id=a+"-"+i+"-tabpanel",n.appendChild(s),r=0;r<e.tabs[i].tabcontent.length;r++)(o=e.tabs[i].tabcontent[r]).hasOwnProperty("flow")&&0==o.contents.length||(o.hasOwnProperty("flow")?C(s,o,a+"-"+i+"-"+r):E(s,o,a+"-"+i+"-"+r));1<l?y(t).find(".mqed-tab").first().addClass("mqed-activetab"):y(d).hide()}(document.getElementById("mqeditor"),h.layout,"mqeditor"):C(document.getElementById("mqeditor"),h.layout,"mqeditor"),y("#mqeditor .mqed-btn.rend").each(function(){g.StaticMath(this,{mouseEvents:!1})}),0<y("#mqeditor .mqed-tabrow").length&&(y("#mqeditor .mqed-tabpanel").hide().first().show(),(s=y("#mqeditor .mqed-tabrow + div")).css("height",s.height()))),"OSK"===h.curlayoutstyle?y("#mqeditor").slideDown(50,function(){var t=y("#mqeditor").height()+5,e=y(window).height()-(a.offset().top+a.outerHeight()-y(window).scrollTop());e<t&&y(window).scrollTop(y(window).scrollTop()+(t-e))}):y("#mqeditor").show(),i(a),f=g.MathField(a[0]),y("#"+a[0].id.substring(8)).triggerHandler("focus"),h.hasOwnProperty("onShow")&&h.onShow(a[0],h.curlayoutstyle,o)}function a(t){"OSK"===h.curlayoutstyle?y("#mqeditor").slideUp(50):y("#mqeditor").hide(),y("#"+f.el().id.substring(8)).trigger("change")}function i(t){var e,a,n,o,s;"under"==h.curlayoutstyle?(a=(e=y(t).closest(".mathquill-math-field")).offset(),n=e.outerHeight(),o=document.getElementById("mqeditor").offsetWidth,(s=a.left)+o>document.documentElement.clientWidth&&(s=document.documentElement.clientWidth-o-5),y("#mqeditor").css("top",a.top+n+3).css("left",s)):y("#mqeditor").css("top","auto").css("left",0)}function q(t){var e,a=t.el();i(a),a.id.match(/mqinput/)&&(e=t.latex(),h.hasOwnProperty("fromMQ")&&(e=h.fromMQ(e)),y("#"+a.id.substring(8)).val(e).trigger("input"),h.hasOwnProperty("onEdit")&&h.onEdit(a.id,e))}function w(t){h.hasOwnProperty("onEnter")&&h.onEnter(t.el().id)}function v(){var t=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||t<500?"OSK":"under"}function C(t,e,a){var n,o,s,l,i,r,d=e.flow,c=100;for(e.hasOwnProperty("s")&&"row"==d&&(c=e.s),n=document.createElement("div"),e.hasOwnProperty("s")&&(n.style.flexGrow=e.s),e.hasOwnProperty("class")&&(n.className=e.class),e.hasOwnProperty("tabpanel")&&(n.id=e.tabpanel.id,n.style.display=e.tabpanel.hidden?"none":""),(o=document.createElement("div")).className="mqed-"+d,r=i=s=0;r<e.contents.length;r++)(l=e.contents[r]).hasOwnProperty("flow")&&0==l.contents.length||(c<s+(i=l.hasOwnProperty("s")?l.s:1)&&(n.appendChild(o),s=0,(o=document.createElement("div")).className="mqed-"+d),l.hasOwnProperty("flow")?C(o,l,a+"-"+r):E(o,l,a+"-"+r),s+=i);n.appendChild(o),t.appendChild(n)}function E(t,e,a){var n,o,s,l,i,r;((o=document.createElement("div")).className="mqed-btn-cont",e.s&&(o.style.flexGrow=e.s),e.contid&&(o.id=e.contid),e.contclass&&y(o).addClass(e.contclass),t.appendChild(o),e.l||e.b||e.p)&&((n=document.createElement("span")).tabIndex=0,e.l?(n.className="mqed-btn rend",n.innerText=e.l,s="c",l=e.l.substring(1)):e.b?(n.className="mqed-btn rend",n.innerHTML=e.b,s="t",((l=e.b).match(/^\d$/)||"."==l)&&y(n).addClass("mqed-digitkey")):(n.className="mqed-btn",n.innerHTML=e.p,s="t",l=e.p),e.c&&("shift"==(s=e.c)?y(n).addClass("mqed-shift"):"k"==s&&y(n).addClass("mqed-navkey")),e.sm&&(n.style.fontSize=100-10*e.sm+"%"),e.w&&(l=e.w),e.tabcontent&&(y(n).addClass("mqed-tab"),s="showtabpanel",l=a+"-tabpanel"),y(n).data("cmdtype",s).data("cmdval",l),y(n).on("click mousedown touchstart keydown",(i=s,r=l,function(t){!function t(e,a,n){var o,s,l,i,r,d,c,u;if(("mousedown"!=e.type||"Backspace"===n)&&!("click"==e.type&&"Backspace"===n||"keydown"==e.type&&"Enter"!==e.key))if("touchstart"==e.type&&(e.preventDefault(),y(e.currentTarget).addClass("mactive")),"t"==a)n.match(/^[a-zA-Z]$/)&&y(e.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(n=n.toUpperCase()),f.typedText(n);else if("c"==a)f.cmd(n);else if("l"==a)f.latex(n);else if("w"==a){if(f.write(n),m=n.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(o=m[1].split(/&/).length,s=0;s<o;s++)f.keystroke("Left")}else"k"==a?(f.keystroke(n),"Backspace"===n&&(p=setTimeout(function(){t(e,a,n)},null===p?600:70))):"m"==a?f.matrixCmd(n):"f"==a?(l=f.getSelection())?(f.write(n+"\\left("+l+"\\right)"),f.keystroke("Left")):n.match(/{}$/)?f.typedText(n.replace(/{}$/,"")):f.write(n):"sf"==a?((l=f.getSelection())?f.write(n+"{"+l+"}"):f.cmd(n),f.keystroke("Left")):"i"==a?((l=f.getSelection())||(l=""),"string"==typeof n?(i=n.charAt(0),r=n.charAt(1),f.write("\\left"+i+l+"\\right"+r)):f.write(n[0]+l+n[1]),""==l&&f.keystroke("Left")):"showtabpanel"==a?((d=y(e.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),d.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),y("#"+n).show(),d.addClass("mqed-activetab"),h.hasOwnProperty("onTab")&&h.onTab(d[0],h.curlayoutstyle,n)):"shift"==a&&(d=y(e.target).closest(".mqed-btn"),c=y(e.target).closest(".mqed-tabpanel"),(u=!d.hasClass("active"))?d.addClass("active"):d.removeClass("active"),c.find(".mqed-btn").each(function(t,e){var a=e.textContent;a.match(/^[a-zA-Z]$/)&&(e.textContent=u?e.textContent.toUpperCase():e.textContent.toLowerCase())}))}(t,i,r)})).on("touchend",function(t){setTimeout(function(){y(t.currentTarget).removeClass("mactive")},50)}).on("touchend mouseup",function(){clearTimeout(p),p=null}),o.appendChild(n))}return{setConfig:function(t){for(var e in t)h[e]=t[e]},setMQconfig:function(t){u=t},toggleMQ:n,toggleMQAll:function(t,e){var a=e||null;y(t).each(function(t,e){n(e,a,!0)})},attachEditor:b,getLayoutstyle:v}}(jQuery);
